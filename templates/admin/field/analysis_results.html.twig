{% set results = field.value %}

{% if results is empty %}
    <p class="text-muted">Zatím žádné výsledky</p>
{% else %}
    <div class="accordion" id="analysisResultsAccordion">
        {% for result in results %}
            {% set resultId = 'result-' ~ loop.index %}
            {% set isCompleted = result.status.value == 'completed' %}
            {% set isFailed = result.status.value == 'failed' %}

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button {{ loop.first ? '' : 'collapsed' }}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#{{ resultId }}">
                        <div class="d-flex w-100 justify-content-between align-items-center me-3">
                            <div>
                                <strong>{{ result.category.label }}</strong>
                                {% set statusClass = {
                                    'pending': 'secondary',
                                    'running': 'warning',
                                    'completed': 'success',
                                    'failed': 'danger'
                                } %}
                                <span class="badge bg-{{ statusClass[result.status.value] ?? 'secondary' }} ms-2">
                                    {{ result.status.value }}
                                </span>
                            </div>
                            <div class="text-end">
                                {% if isCompleted %}
                                    {% set scoreClass = result.score >= 80 ? 'success' : (result.score >= 50 ? 'warning' : 'danger') %}
                                    <span class="badge bg-{{ scoreClass }} me-2">Skóre: {{ result.score }}</span>

                                    {% if result.criticalIssueCount > 0 %}
                                        <span class="badge bg-danger me-2">
                                            <i class="fa fa-exclamation-triangle"></i> {{ result.criticalIssueCount }} kritických
                                        </span>
                                    {% endif %}

                                    {% set nonCriticalCount = result.issueCount - result.criticalIssueCount %}
                                    {% if nonCriticalCount > 0 %}
                                        <span class="badge bg-warning text-dark">{{ nonCriticalCount }} dalších</span>
                                    {% elseif result.issueCount == 0 %}
                                        <span class="badge bg-success"><i class="fa fa-check"></i> OK</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="{{ resultId }}" class="accordion-collapse collapse {{ loop.first ? 'show' : '' }}"
                     data-bs-parent="#analysisResultsAccordion">
                    <div class="accordion-body">
                        {% if isFailed and result.errorMessage %}
                            <div class="alert alert-danger">
                                <i class="fa fa-exclamation-triangle"></i>
                                <strong>Chyba:</strong> {{ result.errorMessage }}
                            </div>
                        {% elseif isCompleted %}
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <small class="text-muted">Zahájeno:</small><br>
                                    {{ result.startedAt ? result.startedAt|date('d.m.Y H:i:s') : '-' }}
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Dokončeno:</small><br>
                                    {{ result.completedAt ? result.completedAt|date('d.m.Y H:i:s') : '-' }}
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Skóre:</small><br>
                                    <strong class="text-{{ scoreClass }}">{{ result.score }}/100</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Problémy:</small><br>
                                    {{ result.issueCount }} ({{ result.criticalIssueCount }} kritických)
                                </div>
                            </div>

                            {# Summary section for rawData display #}
                            {% set summaryFields = result.category.summaryFields %}
                            {% set rawData = result.rawData %}

                            {% if summaryFields is not empty and rawData is not empty %}
                                <div class="mb-3 p-2 bg-body-secondary rounded">
                                    <h6 class="text-muted mb-2">
                                        <i class="fa fa-info-circle"></i> Shrnutí
                                    </h6>
                                    <dl class="row mb-0">
                                        {% for field in summaryFields %}
                                            {% set value = analyzer_get_value(rawData, field.key) %}
                                            {% if value is not null %}
                                                <dt class="col-sm-4 col-md-3 text-muted fw-normal">{{ field.label }}</dt>
                                                <dd class="col-sm-8 col-md-9 mb-1">{{ analyzer_format_value(value, field) }}</dd>
                                            {% endif %}
                                        {% endfor %}
                                    </dl>
                                </div>
                            {% endif %}

                            {% set issues = result.enrichedIssues %}
                            {% if issues is not empty %}
                                <h6 class="mt-3 mb-2">Nalezené problémy:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-secondary">
                                            <tr>
                                                <th style="width: 100px;">Závažnost</th>
                                                <th>Kód</th>
                                                <th>Popis</th>
                                                <th>Evidence</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for issue in issues %}
                                                {% set severity = issue.severity ?? 'info' %}
                                                {% set severityClass = {
                                                    'critical': 'danger',
                                                    'high': 'warning',
                                                    'medium': 'info',
                                                    'low': 'secondary',
                                                    'info': 'light'
                                                } %}
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-{{ severityClass[severity] ?? 'secondary' }}">
                                                            {{ severity }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <code>{{ issue.code ?? '-' }}</code>
                                                    </td>
                                                    <td>
                                                        {% if issue.title is defined %}
                                                            <strong>{{ issue.title }}</strong><br>
                                                        {% endif %}
                                                        {{ issue.description ?? '' }}
                                                        {% if issue.impact is defined and issue.impact %}
                                                            <br><small class="text-muted">Dopad: {{ issue.impact }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if issue.evidence is defined and issue.evidence %}
                                                            <small class="text-break" style="max-width: 300px; display: block;">
                                                                {{ issue.evidence|length > 200 ? issue.evidence|slice(0, 200) ~ '...' : issue.evidence }}
                                                            </small>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-success"><i class="fa fa-check"></i> Žádné problémy nenalezeny</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">Čeká na zpracování...</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}
