{# templates/admin/field/lead_snapshots.html.twig #}
{% set snapshots = field.value %}

{% if snapshots is empty or snapshots.count == 0 %}
    <p class="text-muted">Zatim zadne snapshoty - vytvaraji se automaticky po analyze</p>
{% else %}
    <div class="table-responsive">
        <table class="table table-sm table-striped">
            <thead class="table-light">
                <tr>
                    <th>Obdobi</th>
                    <th>Typ</th>
                    <th>Skore</th>
                    <th>Zmena</th>
                    <th>Problemy</th>
                    <th>Kriticke</th>
                    <th>Vytvoreno</th>
                </tr>
            </thead>
            <tbody>
                {% for snapshot in snapshots %}
                    {% set scoreClass = snapshot.totalScore >= 80 ? 'success' : (snapshot.totalScore >= 50 ? 'warning' : 'danger') %}
                    <tr>
                        <td>{{ snapshot.periodStart|date('d.m.Y') }}</td>
                        <td>
                            {% set periodClass = {
                                'day': 'info',
                                'week': 'primary',
                                'month': 'secondary'
                            } %}
                            <span class="badge bg-{{ periodClass[snapshot.periodType.value] ?? 'secondary' }}">
                                {{ snapshot.periodType.value }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ scoreClass }}">{{ snapshot.totalScore }}</span>
                        </td>
                        <td>
                            {% if snapshot.scoreDelta is not null %}
                                {% if snapshot.scoreDelta > 0 %}
                                    <span class="text-success">+{{ snapshot.scoreDelta }}</span>
                                {% elseif snapshot.scoreDelta < 0 %}
                                    <span class="text-danger">{{ snapshot.scoreDelta }}</span>
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ snapshot.issueCount }}</td>
                        <td>
                            {% if snapshot.criticalIssueCount > 0 %}
                                <span class="badge bg-danger">{{ snapshot.criticalIssueCount }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>{{ snapshot.createdAt|date('d.m.Y H:i') }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Chart for score trending #}
    {% if snapshots.count > 1 %}
        <div class="mt-3">
            <h6>Vyvoj skore</h6>
            <canvas id="snapshotChart" height="150"></canvas>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('snapshotChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [{% for snapshot in snapshots|reverse %}'{{ snapshot.periodStart|date('d.m') }}'{{ not loop.last ? ',' : '' }}{% endfor %}],
                            datasets: [{
                                label: 'Skore',
                                data: [{% for snapshot in snapshots|reverse %}{{ snapshot.totalScore }}{{ not loop.last ? ',' : '' }}{% endfor %}],
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });
                });
            </script>
        </div>
    {% endif %}
{% endif %}
