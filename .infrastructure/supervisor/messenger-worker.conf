; Supervisor configuration for Symfony Messenger workers
; Copy this file to /etc/supervisor/conf.d/ on production servers

; High Priority Worker - emails, webhooks (fast processing)
[program:messenger-high]
command=php /var/www/html/bin/console messenger:consume high_priority --time-limit=3600 --memory-limit=256M
user=www-data
numprocs=2
autostart=true
autorestart=true
startsecs=0
process_name=%(program_name)s_%(process_num)02d
stderr_logfile=/var/log/supervisor/messenger-high-stderr.log
stdout_logfile=/var/log/supervisor/messenger-high-stdout.log

; Normal Priority Worker - analysis, proposals, offers, ARES
[program:messenger-normal]
command=php /var/www/html/bin/console messenger:consume normal --time-limit=3600 --memory-limit=512M
user=www-data
numprocs=2
autostart=true
autorestart=true
startsecs=0
process_name=%(program_name)s_%(process_num)02d
stderr_logfile=/var/log/supervisor/messenger-normal-stderr.log
stdout_logfile=/var/log/supervisor/messenger-normal-stdout.log

; Low Priority Worker - discovery, screenshots, benchmarks
[program:messenger-low]
command=php /var/www/html/bin/console messenger:consume low_priority --time-limit=3600 --memory-limit=512M
user=www-data
numprocs=1
autostart=true
autorestart=true
startsecs=0
process_name=%(program_name)s_%(process_num)02d
stderr_logfile=/var/log/supervisor/messenger-low-stderr.log
stdout_logfile=/var/log/supervisor/messenger-low-stdout.log

; Scheduler Worker - runs scheduled tasks
[program:messenger-scheduler]
command=php /var/www/html/bin/console messenger:consume scheduler_default --time-limit=3600 --memory-limit=128M
user=www-data
numprocs=1
autostart=true
autorestart=true
startsecs=0
process_name=%(program_name)s_%(process_num)02d
stderr_logfile=/var/log/supervisor/messenger-scheduler-stderr.log
stdout_logfile=/var/log/supervisor/messenger-scheduler-stdout.log

; Group for all messenger workers
[group:messenger]
programs=messenger-high,messenger-normal,messenger-low,messenger-scheduler
priority=999
